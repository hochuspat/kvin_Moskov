{"ast":null,"code":"import { _ as _object_spread } from \"@swc/helpers/_/_object_spread\";\nimport { _ as _object_spread_props } from \"@swc/helpers/_/_object_spread_props\";\nimport { _ as _object_without_properties } from \"@swc/helpers/_/_object_without_properties\";\nimport * as React from \"react\";\nimport { useEventListener } from \"../../hooks/useEventListener\";\nimport { useExternRef } from \"../../hooks/useExternRef\";\nimport { useDOM } from \"../../lib/dom\";\nimport { coordX, coordY, getSupportedEvents, touchEnabled } from \"../../lib/touch\";\nimport { useIsomorphicLayoutEffect } from \"../../lib/useIsomorphicLayoutEffect\";\n/**\n * @see https://vkcom.github.io/VKUI/#/Touch\n */\n\nexport var Touch = function (_param) {\n  var onMove = function onMove(e) {\n    var _gesture_current;\n\n    var _ref = (_gesture_current = gesture.current) !== null && _gesture_current !== void 0 ? _gesture_current : {},\n        isPressed = _ref.isPressed,\n        isX = _ref.isX,\n        isY = _ref.isY,\n        _ref_startX = _ref.startX,\n        startX = _ref_startX === void 0 ? 0 : _ref_startX,\n        _ref_startY = _ref.startY,\n        startY = _ref_startY === void 0 ? 0 : _ref_startY;\n\n    if (isPressed) {\n      var _gesture_current1; // смещения\n\n\n      var shiftX = coordX(e) - startX;\n      var shiftY = coordY(e) - startY; // абсолютные значения смещений\n\n      var shiftXAbs = Math.abs(shiftX);\n      var shiftYAbs = Math.abs(shiftY); // Если определяем мультитач, то прерываем жест\n\n      if (!!e.touches && e.touches.length > 1) {\n        return onEnd(e);\n      } // если мы ещё не определились\n\n\n      if (!isX && !isY) {\n        var willBeX = shiftXAbs >= slideThreshold && shiftXAbs > shiftYAbs;\n        var willBeY = shiftYAbs >= slideThreshold && shiftYAbs > shiftXAbs;\n        var willBeSlidedX = willBeX && (!!onMoveX || !!_onMove);\n        var willBeSlidedY = willBeY && (!!onMoveY || !!_onMove);\n\n        if (gesture.current) {\n          Object.assign(gesture.current, {\n            isY: willBeY,\n            isX: willBeX,\n            isSlideX: willBeSlidedX,\n            isSlideY: willBeSlidedY,\n            isSlide: willBeSlidedX || willBeSlidedY\n          });\n        }\n      }\n\n      if ((_gesture_current1 = gesture.current) === null || _gesture_current1 === void 0 ? void 0 : _gesture_current1.isSlide) {\n        Object.assign(gesture.current, {\n          shiftX: shiftX,\n          shiftY: shiftY,\n          shiftXAbs: shiftXAbs,\n          shiftYAbs: shiftYAbs\n        });\n        handle(e, [_onMove, gesture.current.isSlideX && onMoveX, gesture.current.isSlideY && onMoveY]);\n      }\n    }\n  };\n\n  var onEnd = function onEnd(e) {\n    var _gesture_current;\n\n    var _ref = (_gesture_current = gesture.current) !== null && _gesture_current !== void 0 ? _gesture_current : {},\n        isPressed = _ref.isPressed,\n        isSlide = _ref.isSlide,\n        isSlideX = _ref.isSlideX,\n        isSlideY = _ref.isSlideY;\n\n    if (isPressed) {\n      handle(e, [_onEnd, isSlideY && onEndY, isSlideX && onEndX]);\n    }\n\n    var isTouchEnabled = touchEnabled();\n\n    if (isTouchEnabled && isSlide) {\n      // https://github.com/VKCOM/VKUI/issues/4414\n      // если тач-устройство и был зафиксирован touchmove,\n      // то событие клика не вызывается\n      didSlide.current = false;\n    } else {\n      didSlide.current = Boolean(isSlide);\n    }\n\n    gesture.current = {}; // Если это был тач-евент, симулируем отмену hover\n\n    if (isTouchEnabled) {\n      onLeave && onLeave(e);\n    }\n\n    unsubscribe();\n  };\n\n  var subscribe = function subscribe(el) {\n    if (el) {\n      listeners.forEach(function (l) {\n        return l.add(el);\n      });\n    }\n  };\n\n  var unsubscribe = function unsubscribe() {\n    listeners.forEach(function (l) {\n      return l.remove();\n    });\n  };\n\n  var onStart = _param.onStart,\n      onStartX = _param.onStartX,\n      onStartY = _param.onStartY,\n      _onMove = _param.onMove,\n      onMoveX = _param.onMoveX,\n      onMoveY = _param.onMoveY,\n      onLeave = _param.onLeave,\n      onEnter = _param.onEnter,\n      _onEnd = _param.onEnd,\n      onEndX = _param.onEndX,\n      onEndY = _param.onEndY,\n      onClickCapture = _param.onClickCapture,\n      usePointerHover = _param.usePointerHover,\n      _param_slideThreshold = _param.slideThreshold,\n      slideThreshold = _param_slideThreshold === void 0 ? 5 : _param_slideThreshold,\n      _param_useCapture = _param.useCapture,\n      useCapture = _param_useCapture === void 0 ? false : _param_useCapture,\n      _param_Component = _param.Component,\n      Component = _param_Component === void 0 ? \"div\" : _param_Component,\n      getRootRef = _param.getRootRef,\n      _param_noSlideClick = _param.noSlideClick,\n      noSlideClick = _param_noSlideClick === void 0 ? false : _param_noSlideClick,\n      _param_stopPropagation = _param.stopPropagation,\n      stopPropagation = _param_stopPropagation === void 0 ? false : _param_stopPropagation,\n      restProps = _object_without_properties(_param, [\"onStart\", \"onStartX\", \"onStartY\", \"onMove\", \"onMoveX\", \"onMoveY\", \"onLeave\", \"onEnter\", \"onEnd\", \"onEndX\", \"onEndY\", \"onClickCapture\", \"usePointerHover\", \"slideThreshold\", \"useCapture\", \"Component\", \"getRootRef\", \"noSlideClick\", \"stopPropagation\"]);\n\n  var document = useDOM().document;\n  var events = React.useMemo(getSupportedEvents, []);\n  var didSlide = React.useRef(false);\n  var gesture = React.useRef(null);\n\n  var handle = function (e, handlers) {\n    stopPropagation && e.stopPropagation();\n    handlers.forEach(function (cb) {\n      var _gesture_current_startT, _gesture_current;\n\n      var _gesture_current_startT_getTime;\n\n      var duration = Date.now() - ((_gesture_current_startT_getTime = (_gesture_current = gesture.current) === null || _gesture_current === void 0 ? void 0 : (_gesture_current_startT = _gesture_current.startT) === null || _gesture_current_startT === void 0 ? void 0 : _gesture_current_startT.getTime()) !== null && _gesture_current_startT_getTime !== void 0 ? _gesture_current_startT_getTime : 0);\n      cb && cb(_object_spread_props(_object_spread({}, gesture.current), {\n        duration: duration,\n        originalEvent: e\n      }));\n    });\n  };\n\n  var enterHandler = useEventListener(usePointerHover ? \"pointerenter\" : \"mouseenter\", onEnter);\n  var leaveHandler = useEventListener(usePointerHover ? \"pointerleave\" : \"mouseleave\", onLeave);\n  var startHandler = useEventListener(events[0], function (e) {\n    gesture.current = initGesture(coordX(e), coordY(e));\n    handle(e, [onStart, onStartX, onStartY]); // 1 line, 2 bad specs, 2 workarounds:\n\n    subscribe(touchEnabled() ? // see: #235, #1968, https://stackoverflow.com/a/45760014\n    e.target : // if pointer goes outside container.\n    // Can be fixed by PointerEvents' setPointerCapture later\n    document);\n  }, {\n    capture: useCapture,\n    passive: false\n  });\n  var containerRef = useExternRef(getRootRef);\n  useIsomorphicLayoutEffect(function () {\n    var el = containerRef.current;\n\n    if (el) {\n      enterHandler.add(el);\n      leaveHandler.add(el);\n      startHandler.add(el);\n    }\n  }, [Component]);\n  var listenerParams = {\n    capture: useCapture,\n    passive: false\n  };\n  var listeners = [useEventListener(events[1], onMove, listenerParams), useEventListener(events[2], onEnd, listenerParams), useEventListener(events[3], onEnd, listenerParams)];\n  /**\n  * Обработчик событий dragstart\n  * Отменяет нативное браузерное поведение для вложенных ссылок и изображений\n  */\n\n  var onDragStart = function (e) {\n    var target = e.target;\n\n    if (target.tagName === \"A\" || target.tagName === \"IMG\") {\n      e.preventDefault();\n    }\n  };\n  /**\n  * Обработчик клика по компоненту\n  * Отменяет переход по вложенной ссылке, если был зафиксирован свайп\n  */\n\n\n  var postGestureClick = function (e) {\n    if (!didSlide.current) {\n      return onClickCapture && onClickCapture(e);\n    }\n\n    if (noSlideClick) {\n      e.stopPropagation(); // https://github.com/VKCOM/VKUI/issues/1977\n      // https://github.com/VKCOM/VKUI/issues/3892\n\n      e.preventDefault();\n    } else {\n      onClickCapture && onClickCapture(e);\n    }\n\n    didSlide.current = false;\n  };\n\n  return /*#__PURE__*/React.createElement(Component, _object_spread_props(_object_spread({}, restProps), {\n    onDragStart: onDragStart,\n    onClickCapture: postGestureClick,\n    ref: containerRef\n  }));\n};\n\nfunction initGesture(startX, startY) {\n  return {\n    startX: startX,\n    startY: startY,\n    startT: new Date(),\n    duration: 0,\n    isPressed: true,\n    isY: false,\n    isX: false,\n    isSlideX: false,\n    isSlideY: false,\n    isSlide: false,\n    shiftX: 0,\n    shiftY: 0,\n    shiftXAbs: 0,\n    shiftYAbs: 0\n  };\n}","map":{"version":3,"mappings":"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","names":["React","useEventListener","useExternRef","useDOM","coordX","coordY","getSupportedEvents","touchEnabled","useIsomorphicLayoutEffect","Touch","onMove","e","gesture","current","isPressed","isX","isY","startX","_ref_startX","_ref_startY","startY","shiftX","shiftY","shiftXAbs","Math","abs","shiftYAbs","touches","length","onEnd","willBeX","slideThreshold","willBeY","willBeSlidedX","onMoveX","_onMove","willBeSlidedY","onMoveY","Object","assign","isSlideX","isSlideY","isSlide","handle","_onEnd","onEndY","onEndX","isTouchEnabled","didSlide","Boolean","onLeave","unsubscribe","subscribe","el","listeners","forEach","l","add","remove","onStart","onStartX","onStartY","onEnter","onClickCapture","usePointerHover","_param_slideThreshold","_param_useCapture","useCapture","_param_Component","Component","getRootRef","noSlideClick","_param_noSlideClick","_param_stopPropagation","stopPropagation","restProps","document","events","useMemo","useRef","handlers","cb","duration","Date","now","startT","getTime","_object_spread_props","originalEvent","enterHandler","leaveHandler","startHandler","initGesture","target","capture","passive","containerRef","listenerParams","onDragStart","tagName","preventDefault","postGestureClick","ref"],"sources":["C:\\Users\\kulag\\vk\\Ability\\node_modules\\@vkontakte\\vkui\\src\\components\\Touch\\Touch.tsx"],"sourcesContent":["import * as React from 'react';\nimport { useEventListener } from '../../hooks/useEventListener';\nimport { useExternRef } from '../../hooks/useExternRef';\nimport { useDOM } from '../../lib/dom';\nimport { coordX, coordY, getSupportedEvents, touchEnabled, VKUITouchEvent } from '../../lib/touch';\nimport { useIsomorphicLayoutEffect } from '../../lib/useIsomorphicLayoutEffect';\nimport { HasComponent, HasRootRef } from '../../types';\n\nexport interface TouchProps\n  extends React.AllHTMLAttributes<HTMLElement>,\n    HasRootRef<HTMLElement>,\n    HasComponent {\n  /**\n   * Привязать onEnter и onLeave через pointer-events - работает на disabled-инпутах\n   */\n  usePointerHover?: boolean;\n  useCapture?: boolean;\n  slideThreshold?: number;\n  noSlideClick?: boolean;\n  onEnter?: HoverHandler;\n  onLeave?: HoverHandler;\n  onStart?: TouchEventHandler;\n  onStartX?: TouchEventHandler;\n  onStartY?: TouchEventHandler;\n  onMove?: TouchEventHandler;\n  onMoveX?: TouchEventHandler;\n  onMoveY?: TouchEventHandler;\n  onEnd?: TouchEventHandler;\n  onEndX?: TouchEventHandler;\n  onEndY?: TouchEventHandler;\n  stopPropagation?: boolean;\n}\n\nexport interface Gesture {\n  startX: number;\n  startY: number;\n  startT: Date;\n  duration: number;\n  isPressed: boolean;\n  isY: boolean;\n  isX: boolean;\n  isSlideX: boolean;\n  isSlideY: boolean;\n  isSlide: boolean;\n  shiftX: number;\n  shiftY: number;\n  shiftXAbs: number;\n  shiftYAbs: number;\n}\n\nexport interface TouchEvent extends Gesture {\n  originalEvent: VKUITouchEvent;\n}\n\ntype HoverHandler = (outputEvent: MouseEvent) => void;\nexport type TouchEventHandler = (e: TouchEvent) => void;\nexport type ClickHandler = (e: React.MouseEvent<HTMLElement>) => void;\nexport type DragHandler = (e: React.DragEvent<HTMLElement>) => void;\n\n/**\n * @see https://vkcom.github.io/VKUI/#/Touch\n */\nexport const Touch = ({\n  onStart,\n  onStartX,\n  onStartY,\n  onMove: _onMove,\n  onMoveX,\n  onMoveY,\n  onLeave,\n  onEnter,\n  onEnd: _onEnd,\n  onEndX,\n  onEndY,\n  onClickCapture,\n  usePointerHover,\n  slideThreshold = 5,\n  useCapture = false,\n  Component = 'div',\n  getRootRef,\n  noSlideClick = false,\n  stopPropagation = false,\n  ...restProps\n}: TouchProps) => {\n  const { document } = useDOM();\n  const events = React.useMemo(getSupportedEvents, []);\n  const didSlide = React.useRef(false);\n  const gesture = React.useRef<Partial<Gesture> | null>(null);\n  const handle = (e: VKUITouchEvent, handlers: Array<TouchEventHandler | undefined | false>) => {\n    stopPropagation && e.stopPropagation();\n    handlers.forEach((cb) => {\n      const duration = Date.now() - (gesture.current?.startT?.getTime() ?? 0);\n      cb && cb({ ...(gesture.current as Gesture), duration, originalEvent: e });\n    });\n  };\n\n  const enterHandler = useEventListener(usePointerHover ? 'pointerenter' : 'mouseenter', onEnter);\n  const leaveHandler = useEventListener(usePointerHover ? 'pointerleave' : 'mouseleave', onLeave);\n  const startHandler = useEventListener(\n    events[0],\n    (e: VKUITouchEvent) => {\n      gesture.current = initGesture(coordX(e), coordY(e));\n\n      handle(e, [onStart, onStartX, onStartY]);\n      // 1 line, 2 bad specs, 2 workarounds:\n      subscribe(\n        touchEnabled()\n          ? // Touch events fire on initial target, and won't bubble if its removed\n            // see: #235, #1968, https://stackoverflow.com/a/45760014\n            (e.target as HTMLElement)\n          : // Mouse events fire on the element under pointer, so we lose move / end\n            // if pointer goes outside container.\n            // Can be fixed by PointerEvents' setPointerCapture later\n            document,\n      );\n    },\n    { capture: useCapture, passive: false },\n  );\n  const containerRef = useExternRef(getRootRef);\n\n  useIsomorphicLayoutEffect(() => {\n    const el = containerRef.current;\n    if (el) {\n      enterHandler.add(el);\n      leaveHandler.add(el);\n      startHandler.add(el);\n    }\n  }, [Component]);\n\n  function onMove(e: VKUITouchEvent) {\n    const { isPressed, isX, isY, startX = 0, startY = 0 } = gesture.current ?? {};\n\n    if (isPressed) {\n      // смещения\n      const shiftX = coordX(e) - startX;\n      const shiftY = coordY(e) - startY;\n\n      // абсолютные значения смещений\n      const shiftXAbs = Math.abs(shiftX);\n      const shiftYAbs = Math.abs(shiftY);\n\n      // Если определяем мультитач, то прерываем жест\n      if (!!e.touches && e.touches.length > 1) {\n        return onEnd(e);\n      }\n\n      // если мы ещё не определились\n      if (!isX && !isY) {\n        const willBeX = shiftXAbs >= slideThreshold && shiftXAbs > shiftYAbs;\n        const willBeY = shiftYAbs >= slideThreshold && shiftYAbs > shiftXAbs;\n        const willBeSlidedX = willBeX && (!!onMoveX || !!_onMove);\n        const willBeSlidedY = willBeY && (!!onMoveY || !!_onMove);\n\n        if (gesture.current) {\n          Object.assign(gesture.current, {\n            isY: willBeY,\n            isX: willBeX,\n            isSlideX: willBeSlidedX,\n            isSlideY: willBeSlidedY,\n            isSlide: willBeSlidedX || willBeSlidedY,\n          });\n        }\n      }\n\n      if (gesture.current?.isSlide) {\n        Object.assign(gesture.current, {\n          shiftX,\n          shiftY,\n          shiftXAbs,\n          shiftYAbs,\n        });\n\n        handle(e, [\n          _onMove,\n          gesture.current.isSlideX && onMoveX,\n          gesture.current.isSlideY && onMoveY,\n        ]);\n      }\n    }\n  }\n\n  function onEnd(e: VKUITouchEvent) {\n    const { isPressed, isSlide, isSlideX, isSlideY } = gesture.current ?? {};\n\n    if (isPressed) {\n      handle(e, [_onEnd, isSlideY && onEndY, isSlideX && onEndX]);\n    }\n\n    const isTouchEnabled = touchEnabled();\n\n    if (isTouchEnabled && isSlide) {\n      // https://github.com/VKCOM/VKUI/issues/4414\n      // если тач-устройство и был зафиксирован touchmove,\n      // то событие клика не вызывается\n      didSlide.current = false;\n    } else {\n      didSlide.current = Boolean(isSlide);\n    }\n    gesture.current = {};\n\n    // Если это был тач-евент, симулируем отмену hover\n    if (isTouchEnabled) {\n      onLeave && onLeave(e);\n    }\n    unsubscribe();\n  }\n\n  const listenerParams = { capture: useCapture, passive: false };\n  const listeners = [\n    useEventListener(events[1], onMove, listenerParams),\n    useEventListener(events[2], onEnd, listenerParams),\n    useEventListener(events[3], onEnd, listenerParams),\n  ];\n  function subscribe(el: HTMLElement | Document | null | undefined) {\n    if (el) {\n      listeners.forEach((l) => l.add(el));\n    }\n  }\n  function unsubscribe() {\n    listeners.forEach((l) => l.remove());\n  }\n\n  /**\n   * Обработчик событий dragstart\n   * Отменяет нативное браузерное поведение для вложенных ссылок и изображений\n   */\n  const onDragStart = (e: React.DragEvent<HTMLElement>) => {\n    const target = e.target as HTMLElement;\n    if (target.tagName === 'A' || target.tagName === 'IMG') {\n      e.preventDefault();\n    }\n  };\n\n  /**\n   * Обработчик клика по компоненту\n   * Отменяет переход по вложенной ссылке, если был зафиксирован свайп\n   */\n  const postGestureClick: typeof onClickCapture = (e) => {\n    if (!didSlide.current) {\n      return onClickCapture && onClickCapture(e);\n    }\n\n    if (noSlideClick) {\n      e.stopPropagation();\n\n      // https://github.com/VKCOM/VKUI/issues/1977\n      // https://github.com/VKCOM/VKUI/issues/3892\n      e.preventDefault();\n    } else {\n      onClickCapture && onClickCapture(e);\n    }\n\n    didSlide.current = false;\n  };\n\n  return (\n    <Component\n      {...restProps}\n      onDragStart={onDragStart}\n      onClickCapture={postGestureClick}\n      ref={containerRef}\n    />\n  );\n};\n\nfunction initGesture(startX: number, startY: number): Gesture {\n  return {\n    startX,\n    startY,\n    startT: new Date(),\n    duration: 0,\n    isPressed: true,\n    isY: false,\n    isX: false,\n    isSlideX: false,\n    isSlideY: false,\n    isSlide: false,\n    shiftX: 0,\n    shiftY: 0,\n    shiftXAbs: 0,\n    shiftYAbs: 0,\n  };\n}\n"]},"metadata":{},"sourceType":"module"}