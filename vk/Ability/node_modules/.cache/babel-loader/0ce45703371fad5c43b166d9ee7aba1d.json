{"ast":null,"code":"import { _ as _assert_this_initialized } from \"@swc/helpers/_/_assert_this_initialized\";\nimport { _ as _class_call_check } from \"@swc/helpers/_/_class_call_check\";\nimport { _ as _create_class } from \"@swc/helpers/_/_create_class\";\nimport { _ as _define_property } from \"@swc/helpers/_/_define_property\";\nimport { _ as _inherits } from \"@swc/helpers/_/_inherits\";\nimport { _ as _object_spread } from \"@swc/helpers/_/_object_spread\";\nimport { _ as _object_without_properties } from \"@swc/helpers/_/_object_without_properties\";\nimport { _ as _to_consumable_array } from \"@swc/helpers/_/_to_consumable_array\";\nimport { _ as _create_super } from \"@swc/helpers/_/_create_super\";\nimport * as React from \"react\";\nimport { classNames } from \"@vkontakte/vkjs\";\nimport { clamp } from \"../../helpers/math\";\nimport { withContext } from \"../../hoc/withContext\";\nimport { withPlatform } from \"../../hoc/withPlatform\";\nimport { withDOM } from \"../../lib/dom\";\nimport { getNavId } from \"../../lib/getNavId\";\nimport { Platform } from \"../../lib/platform\";\nimport { setTransformStyle } from \"../../lib/styles\";\nimport { transitionEvent } from \"../../lib/supportEvents\";\nimport { rubber } from \"../../lib/touch\";\nimport { warnOnce } from \"../../lib/warnOnce\";\nimport { ConfigProviderContext } from \"../ConfigProvider/ConfigProviderContext\";\nimport { FocusTrap } from \"../FocusTrap/FocusTrap\";\nimport { Touch } from \"../Touch/Touch\";\nimport TouchRootContext from \"../Touch/TouchContext\";\nimport { ModalRootContext } from \"./ModalRootContext\";\nimport { MODAL_PAGE_DEFAULT_PERCENT_HEIGHT } from \"./constants\";\nimport { ModalType } from \"./types\";\nimport { withModalManager } from \"./useModalManager\";\nvar warn = warnOnce(\"ModalRoot\");\n\nfunction numberInRange(number, range) {\n  if (!range) {\n    return false;\n  }\n\n  return number >= range[0] && number <= range[1];\n}\n\nfunction rangeTranslate(number) {\n  return clamp(number, 0, 98);\n}\n\nvar ModalRootTouchComponent = /*#__PURE__*/function (_React_Component) {\n  \"use strict\";\n\n  _inherits(ModalRootTouchComponent, _React_Component);\n\n  var _super = _create_super(ModalRootTouchComponent);\n\n  function ModalRootTouchComponent(props) {\n    _class_call_check(this, ModalRootTouchComponent);\n\n    var _this;\n\n    _this = _super.call(this, props);\n\n    _define_property(_assert_this_initialized(_this), \"documentScrolling\", false);\n\n    _define_property(_assert_this_initialized(_this), \"maskElementRef\", void 0);\n\n    _define_property(_assert_this_initialized(_this), \"viewportRef\", /*#__PURE__*/React.createRef());\n\n    _define_property(_assert_this_initialized(_this), \"maskAnimationFrame\", undefined);\n\n    _define_property(_assert_this_initialized(_this), \"modalRootContext\", void 0);\n\n    _define_property(_assert_this_initialized(_this), \"frameIds\", void 0);\n\n    _define_property(_assert_this_initialized(_this), \"restoreFocusTo\", undefined);\n\n    _define_property(_assert_this_initialized(_this), \"preventTouch\", function (event) {\n      if (!event) {\n        return false;\n      }\n\n      while (event.originalEvent) {\n        event = event.originalEvent;\n      }\n\n      if (event.preventDefault) {\n        event.preventDefault();\n      }\n\n      return false;\n    });\n\n    _define_property(_assert_this_initialized(_this), \"updateModalHeight\", function () {\n      var modalState = _this.props.getModalState(_this.props.activeModal);\n\n      if (modalState && modalState.type === ModalType.PAGE) {\n        if (_this.props.enteringModal) {\n          _this.waitTransitionFinish(modalState, function () {\n            requestAnimationFrame(function () {\n              return _this.checkPageContentHeight();\n            });\n          });\n        } else {\n          requestAnimationFrame(function () {\n            return _this.checkPageContentHeight();\n          });\n        }\n      }\n    });\n\n    _define_property(_assert_this_initialized(_this), \"onTouchMove\", function (e) {\n      if (_this.props.exitingModal) {\n        return;\n      }\n\n      var modalState = _this.props.getModalState(_this.props.activeModal);\n\n      if (!modalState) {\n        return;\n      }\n\n      if (modalState.type === ModalType.PAGE) {\n        return _this.onPageTouchMove(e, modalState);\n      }\n\n      if (modalState.type === ModalType.CARD) {\n        return _this.onCardTouchMove(e, modalState);\n      }\n    });\n\n    _define_property(_assert_this_initialized(_this), \"onTouchEnd\", function (e) {\n      var modalState = _this.props.getModalState(_this.props.activeModal);\n\n      if ((modalState === null || modalState === void 0 ? void 0 : modalState.type) === ModalType.PAGE) {\n        return _this.onPageTouchEnd(e, modalState);\n      }\n\n      if ((modalState === null || modalState === void 0 ? void 0 : modalState.type) === ModalType.CARD) {\n        return _this.onCardTouchEnd(e, modalState);\n      }\n    });\n\n    _define_property(_assert_this_initialized(_this), \"onScroll\", function (e) {\n      var _modalState_contentElement;\n\n      var activeModal = _this.props.activeModal;\n      var target = e.target;\n\n      if (!activeModal) {\n        return;\n      }\n\n      var modalState = _this.props.getModalState(activeModal);\n\n      if ((modalState === null || modalState === void 0 ? void 0 : modalState.type) === ModalType.PAGE && (modalState === null || modalState === void 0 ? void 0 : (_modalState_contentElement = modalState.contentElement) === null || _modalState_contentElement === void 0 ? void 0 : _modalState_contentElement.contains(target))) {\n        modalState.contentScrolled = true;\n\n        if (modalState.contentScrollStopTimeout) {\n          clearTimeout(modalState.contentScrollStopTimeout);\n        }\n\n        modalState.contentScrollStopTimeout = setTimeout(function () {\n          if (modalState.contentScrolled) {\n            modalState.contentScrolled = false;\n          }\n        }, 250);\n      }\n    });\n\n    _this.state = {\n      touchDown: false,\n      dragging: false,\n      modalOpenedLog: []\n    };\n    _this.maskElementRef = /*#__PURE__*/React.createRef();\n    _this.modalRootContext = {\n      updateModalHeight: _this.updateModalHeight,\n      registerModal: function (_param) {\n        var id = _param.id,\n            data = _object_without_properties(_param, [\"id\"]);\n\n        var _this_props_getModalState;\n\n        return Object.assign((_this_props_getModalState = _this.props.getModalState(id)) !== null && _this_props_getModalState !== void 0 ? _this_props_getModalState : {}, data);\n      },\n      onClose: function () {\n        return _this.props.onExit();\n      },\n      isInsideModal: true\n    };\n    _this.frameIds = {};\n    return _this;\n  }\n\n  _create_class(ModalRootTouchComponent, [{\n    key: \"timeout\",\n    get: function get() {\n      return this.props.platform === Platform.IOS ? 400 : 320;\n    }\n  }, {\n    key: \"document\",\n    get: function get() {\n      return this.props.document;\n    }\n  }, {\n    key: \"window\",\n    get: function get() {\n      return this.props.window;\n    }\n  }, {\n    key: \"getModals\",\n    value: function getModals() {\n      return React.Children.toArray(this.props.children);\n    }\n  }, {\n    key: \"componentDidMount\",\n    value: function componentDidMount() {\n      var // Отслеживаем изменение размеров viewport\n      _this_window;\n\n      (_this_window = this.window) === null || _this_window === void 0 ? void 0 : _this_window.addEventListener(\"resize\", this.updateModalHeight, false);\n    }\n  }, {\n    key: \"componentWillUnmount\",\n    value: function componentWillUnmount() {\n      this.toggleDocumentScrolling(true);\n      this.window.removeEventListener(\"resize\", this.updateModalHeight, false);\n    }\n  }, {\n    key: \"componentDidUpdate\",\n    value: function componentDidUpdate(prevProps) {\n      var _this = this; // transition phase 2: animate exiting modal\n\n\n      if (this.props.exitingModal && this.props.exitingModal !== prevProps.exitingModal) {\n        this.closeModal(this.props.exitingModal);\n      } // transition phase 3: animate entering modal\n\n\n      if (this.props.enteringModal && this.props.enteringModal !== prevProps.enteringModal) {\n        var enteringState = this.props.getModalState(this.props.enteringModal);\n        this.props.onEnter();\n        this.waitTransitionFinish(enteringState, function () {\n          if (enteringState) {\n            if (enteringState.innerElement) {\n              enteringState.innerElement.style.transitionDelay = \"\";\n            }\n\n            _this.onEntered(enteringState);\n          }\n        });\n\n        if (enteringState === null || enteringState === void 0 ? void 0 : enteringState.innerElement) {\n          enteringState.innerElement.style.transitionDelay = this.props.delayEnter ? \"\".concat(this.timeout, \"ms\") : \"\";\n          this.animateTranslate(enteringState, enteringState.translateY);\n          this.setMaskOpacity(enteringState, 1);\n        }\n      } // focus restoration\n\n\n      if (this.props.activeModal && !prevProps.activeModal) {\n        this.restoreFocusTo = this.document.activeElement;\n      }\n\n      if (!this.props.activeModal && !this.props.exitingModal && this.restoreFocusTo) {\n        this.restoreFocusTo.focus();\n        this.restoreFocusTo = null;\n      }\n\n      this.toggleDocumentScrolling(!this.props.activeModal && !this.props.exitingModal);\n    }\n  }, {\n    /* Отключает скролл документа */\n    key: \"toggleDocumentScrolling\",\n    value: function toggleDocumentScrolling(enabled) {\n      if (this.documentScrolling === enabled) {\n        return;\n      }\n\n      this.documentScrolling = enabled;\n\n      if (enabled) {\n        // восстанавливаем значение overscroll behavior\n        // eslint-disable-next-line no-restricted-properties\n        this.document.documentElement.classList.remove(\"vkui--disable-overscroll-behavior\"); // некоторые браузеры на странных вендорах типа Meizu не удаляют обработчик.\n        // https://github.com/VKCOM/VKUI/issues/444\n\n        this.window.removeEventListener(\"touchmove\", this.preventTouch, {\n          // @ts-expect-error: TS2769 В интерфейсе EventListenerOptions нет поля passive\n          passive: false\n        });\n      } else {\n        // отключаем нативный pull-to-refresh при открытом модальном окне\n        // чтобы он не срабатывал при закрытии модалки смахиванием вниз\n        // eslint-disable-next-line no-restricted-properties\n        this.document.documentElement.classList.add(\"vkui--disable-overscroll-behavior\");\n        this.window.addEventListener(\"touchmove\", this.preventTouch, {\n          passive: false\n        });\n      }\n    }\n  }, {\n    key: \"checkPageContentHeight\",\n    value: function checkPageContentHeight() {\n      var modalState = this.props.getModalState(this.props.activeModal);\n\n      if ((modalState === null || modalState === void 0 ? void 0 : modalState.type) === ModalType.PAGE && (modalState === null || modalState === void 0 ? void 0 : modalState.modalElement)) {\n        var prevModalState = _object_spread({}, modalState);\n\n        initPageModal(modalState);\n\n        var currentModalState = _object_spread({}, modalState);\n\n        var needAnimate = false;\n\n        if (prevModalState.expandable === currentModalState.expandable) {\n          if (prevModalState.translateYFrom !== currentModalState.translateYFrom) {\n            needAnimate = true;\n          }\n        } else {\n          needAnimate = true;\n        }\n\n        if (needAnimate) {\n          this.animateTranslate(modalState, modalState.translateY);\n        }\n      }\n    }\n  }, {\n    key: \"onEntered\",\n    value: function onEntered(param) {\n      var id = param.id,\n          modalElement = param.modalElement;\n\n      if (!this.props.noFocusToDialog && modalElement && !modalElement.contains(this.document.activeElement)) {\n        modalElement.focus();\n      }\n\n      this.props.onEntered(id);\n    }\n  }, {\n    key: \"closeModal\",\n    value: function closeModal(id) {\n      var _this = this; // Сбрасываем состояния, которые могут помешать закрытию модального окна\n\n\n      this.setState({\n        touchDown: false\n      });\n      var prevModalState = this.props.getModalState(id);\n\n      if (!prevModalState) {\n        id && warn(\"closeActiveModal: модальное окно (страница) \".concat(id, \" не существует\"), \"error\");\n        return;\n      }\n\n      if (!this.state.modalOpenedLog.length) {\n        this.setState(function (prevState) {\n          return {\n            modalOpenedLog: _to_consumable_array(prevState.modalOpenedLog).concat([id])\n          };\n        });\n      }\n\n      var nextModalState = this.props.getModalState(this.props.activeModal);\n      var nextIsPage = !!nextModalState && nextModalState.type === ModalType.PAGE;\n      var prevIsPage = !!prevModalState && prevModalState.type === ModalType.PAGE;\n      this.waitTransitionFinish(prevModalState, function () {\n        return _this.props.onExited(id);\n      });\n\n      var _prevModalState_translateY, _nextModalState_translateYFrom, _nextModalState_translateYFrom1;\n\n      var exitTranslate = prevIsPage && nextIsPage && ((_prevModalState_translateY = prevModalState.translateY) !== null && _prevModalState_translateY !== void 0 ? _prevModalState_translateY : 0) <= ((_nextModalState_translateYFrom = nextModalState === null || nextModalState === void 0 ? void 0 : nextModalState.translateYFrom) !== null && _nextModalState_translateYFrom !== void 0 ? _nextModalState_translateYFrom : 0) && !this.props.isBack ? ((_nextModalState_translateYFrom1 = nextModalState === null || nextModalState === void 0 ? void 0 : nextModalState.translateYFrom) !== null && _nextModalState_translateYFrom1 !== void 0 ? _nextModalState_translateYFrom1 : 0) + 10 : 100;\n      this.animateTranslate(prevModalState, exitTranslate);\n\n      if (!nextModalState) {\n        // NOTE: was only for clean exit\n        this.setMaskOpacity(prevModalState, 0);\n        this.setState({\n          modalOpenedLog: []\n        });\n        prevModalState.translateY = undefined;\n      } else if (nextModalState.id && !this.state.modalOpenedLog.includes(nextModalState.id)) {\n        nextModalState.translateY = undefined;\n        this.setState(function (prevState) {\n          return {\n            modalOpenedLog: _to_consumable_array(prevState.modalOpenedLog).concat([nextModalState.id])\n          };\n        });\n      }\n    }\n  }, {\n    key: \"onPageTouchMove\",\n    value: function onPageTouchMove(event, modalState) {\n      var _modalState_innerElement, _modalState_headerElement;\n\n      var shiftY = event.shiftY,\n          originalEvent = event.originalEvent;\n      var target = originalEvent.target;\n\n      if (!event.isY) {\n        var _this_viewportRef_current;\n\n        if ((_this_viewportRef_current = this.viewportRef.current) === null || _this_viewportRef_current === void 0 ? void 0 : _this_viewportRef_current.contains(target)) {\n          originalEvent.preventDefault();\n        }\n\n        return;\n      }\n\n      if (!((_modalState_innerElement = modalState.innerElement) === null || _modalState_innerElement === void 0 ? void 0 : _modalState_innerElement.contains(target))) {\n        return originalEvent.preventDefault();\n      }\n\n      originalEvent.stopPropagation();\n      var expandable = modalState.expandable,\n          contentScrolled = modalState.contentScrolled,\n          collapsed = modalState.collapsed,\n          expanded = modalState.expanded;\n\n      if (!this.state.touchDown) {\n        var _modalState_contentElement;\n\n        var _modalState_contentElement_scrollTop;\n\n        modalState.touchStartContentScrollTop = (_modalState_contentElement_scrollTop = (_modalState_contentElement = modalState.contentElement) === null || _modalState_contentElement === void 0 ? void 0 : _modalState_contentElement.scrollTop) !== null && _modalState_contentElement_scrollTop !== void 0 ? _modalState_contentElement_scrollTop : 0;\n        this.setState({\n          touchDown: true\n        });\n      }\n\n      if (contentScrolled) {\n        return;\n      }\n\n      if (modalState.touchMovePositive === null) {\n        modalState.touchMovePositive = shiftY > 0;\n      }\n\n      if (!modalState.expandable || collapsed || expanded && modalState.touchMovePositive && modalState.touchStartContentScrollTop === 0 || ((_modalState_headerElement = modalState.headerElement) === null || _modalState_headerElement === void 0 ? void 0 : _modalState_headerElement.contains(target))) {\n        originalEvent.preventDefault();\n\n        if (!expandable && shiftY < 0 || !this.window) {\n          return;\n        }\n\n        !this.state.dragging && this.setState({\n          dragging: true\n        });\n        var shiftYPercent = shiftY / this.window.innerHeight * 100;\n        var shiftYCurrent = rubber(shiftYPercent, 72, 0.8, this.props.platform !== Platform.IOS);\n        modalState.touchShiftYPercent = shiftYPercent;\n\n        var _modalState_translateY;\n\n        modalState.translateYCurrent = rangeTranslate(((_modalState_translateY = modalState.translateY) !== null && _modalState_translateY !== void 0 ? _modalState_translateY : 0) + shiftYCurrent);\n        this.animateTranslate(modalState, modalState.translateYCurrent);\n        this.setMaskOpacity(modalState);\n      }\n    }\n  }, {\n    key: \"onCardTouchMove\",\n    value: function onCardTouchMove(event, modalState) {\n      var _modalState_innerElement;\n\n      var originalEvent = event.originalEvent,\n          shiftY = event.shiftY;\n      var target = originalEvent.target;\n\n      if ((_modalState_innerElement = modalState.innerElement) === null || _modalState_innerElement === void 0 ? void 0 : _modalState_innerElement.contains(target)) {\n        if (!this.state.touchDown) {\n          this.setState({\n            touchDown: true,\n            dragging: true\n          });\n        }\n\n        var shiftYPercent = shiftY / modalState.innerElement.offsetHeight * 100;\n        var shiftYCurrent = rubber(shiftYPercent, 72, 1.2, this.props.platform !== Platform.IOS);\n        modalState.touchShiftYPercent = shiftYPercent;\n\n        var _modalState_translateY;\n\n        modalState.translateYCurrent = Math.max(0, ((_modalState_translateY = modalState.translateY) !== null && _modalState_translateY !== void 0 ? _modalState_translateY : 0) + shiftYCurrent);\n        this.animateTranslate(modalState, modalState.translateYCurrent);\n        this.setMaskOpacity(modalState);\n      }\n    }\n  }, {\n    key: \"onPageTouchEnd\",\n    value: function onPageTouchEnd(event, modalState) {\n      var _this = this;\n\n      var startY = event.startY,\n          shiftY = event.shiftY;\n      modalState.contentScrolled = false;\n      modalState.touchMovePositive = null;\n      var setStateCallback;\n\n      if (this.state.dragging && this.window) {\n        var shiftYEndPercent = (startY + shiftY) / this.window.innerHeight * 100;\n\n        var _modalState_translateYCurrent;\n\n        var translateY = (_modalState_translateYCurrent = modalState.translateYCurrent) !== null && _modalState_translateYCurrent !== void 0 ? _modalState_translateYCurrent : 0;\n\n        var _modalState_touchShiftYPercent;\n\n        var expectTranslateY = translateY / event.duration * 240 * 0.6 * (((_modalState_touchShiftYPercent = modalState.touchShiftYPercent) !== null && _modalState_touchShiftYPercent !== void 0 ? _modalState_touchShiftYPercent : 0) < 0 ? -1 : 1);\n        translateY = rangeTranslate(translateY + expectTranslateY);\n\n        if (modalState.settlingHeight !== 100) {\n          if (numberInRange(translateY, modalState.expandedRange)) {\n            var _modalState_expandedRange;\n\n            var _modalState_expandedRange_;\n\n            translateY = (_modalState_expandedRange_ = (_modalState_expandedRange = modalState.expandedRange) === null || _modalState_expandedRange === void 0 ? void 0 : _modalState_expandedRange[0]) !== null && _modalState_expandedRange_ !== void 0 ? _modalState_expandedRange_ : 0;\n          } else if (numberInRange(translateY, modalState.collapsedRange)) {\n            var _modalState_translateYFrom;\n\n            translateY = (_modalState_translateYFrom = modalState.translateYFrom) !== null && _modalState_translateYFrom !== void 0 ? _modalState_translateYFrom : 0;\n          } else if (numberInRange(translateY, modalState.hiddenRange)) {\n            translateY = 100;\n          } else {\n            var _modalState_translateYFrom1;\n\n            translateY = (_modalState_translateYFrom1 = modalState.translateYFrom) !== null && _modalState_translateYFrom1 !== void 0 ? _modalState_translateYFrom1 : 0;\n          }\n        } else {\n          if (numberInRange(translateY, [0, 25])) {\n            translateY = 0;\n          } else {\n            translateY = 100;\n          }\n        }\n\n        if (translateY !== 100 && shiftYEndPercent >= 75) {\n          translateY = 100;\n        }\n\n        modalState.translateY = translateY;\n        modalState.translateYCurrent = translateY;\n        modalState.collapsed = numberInRange(translateY, modalState.collapsedRange);\n        modalState.expanded = translateY === 0;\n        modalState.hidden = translateY === 100;\n\n        if (modalState.hidden) {\n          this.props.onExit();\n        }\n\n        setStateCallback = function () {\n          if (!modalState.hidden) {\n            _this.animateTranslate(modalState, modalState.translateY);\n          }\n\n          _this.setMaskOpacity(modalState);\n        };\n      }\n\n      this.setState({\n        touchDown: false,\n        dragging: false\n      }, setStateCallback);\n    }\n  }, {\n    key: \"onCardTouchEnd\",\n    value: function onCardTouchEnd(param, modalState) {\n      var duration = param.duration;\n\n      var _this = this;\n\n      var setStateCallback;\n\n      if (this.state.dragging) {\n        var _modalState_translateYCurrent;\n\n        var translateY = (_modalState_translateYCurrent = modalState.translateYCurrent) !== null && _modalState_translateYCurrent !== void 0 ? _modalState_translateYCurrent : 0;\n\n        var _modalState_touchShiftYPercent;\n\n        var expectTranslateY = translateY / duration * 240 * 0.6 * (((_modalState_touchShiftYPercent = modalState.touchShiftYPercent) !== null && _modalState_touchShiftYPercent !== void 0 ? _modalState_touchShiftYPercent : 0) < 0 ? -1 : 1);\n        translateY = Math.max(0, translateY + expectTranslateY);\n\n        if (translateY >= 30) {\n          translateY = 100;\n        } else {\n          translateY = 0;\n        }\n\n        modalState.translateY = translateY;\n        modalState.hidden = translateY === 100;\n\n        if (modalState.hidden) {\n          this.props.onExit();\n        }\n\n        setStateCallback = function () {\n          if (!modalState.hidden) {\n            _this.animateTranslate(modalState, modalState.translateY);\n          }\n\n          _this.setMaskOpacity(modalState);\n        };\n      }\n\n      this.setState({\n        touchDown: false,\n        dragging: false\n      }, setStateCallback);\n    }\n  }, {\n    key: \"waitTransitionFinish\",\n    value: function waitTransitionFinish(modalState, eventHandler) {\n      if (transitionEvent.supported) {\n        var _modalState_innerElement;\n\n        var onceHandler = function () {\n          var _modalState_innerElement;\n\n          modalState === null || modalState === void 0 ? void 0 : (_modalState_innerElement = modalState.innerElement) === null || _modalState_innerElement === void 0 ? void 0 : _modalState_innerElement.removeEventListener(transitionEvent.name, onceHandler);\n          eventHandler();\n        };\n\n        modalState === null || modalState === void 0 ? void 0 : (_modalState_innerElement = modalState.innerElement) === null || _modalState_innerElement === void 0 ? void 0 : _modalState_innerElement.addEventListener(transitionEvent.name, onceHandler);\n      } else {\n        setTimeout(eventHandler, this.timeout);\n      }\n    }\n  }, {\n    /**\n    * Анимирует сдвиг модалки\n    *\n    * @param {ModalsStateEntry} modalState\n    * @param {number} percent Процент сдвига: 0 – полностью открыта, 100 – полностью закрыта\n    */\n    key: \"animateTranslate\",\n    value: function animateTranslate(modalState, percent) {\n      var frameId = \"animateTranslateFrame\".concat(modalState.id);\n      cancelAnimationFrame(this.frameIds[frameId]);\n      this.frameIds[frameId] = requestAnimationFrame(function () {\n        setTransformStyle(modalState.innerElement, \"translate3d(0, \".concat(percent, \"%, 0)\"));\n      });\n    }\n  }, {\n    /* Устанавливает прозрачность для полупрозрачной подложки */\n    key: \"setMaskOpacity\",\n    value: function setMaskOpacity(modalState) {\n      var forceOpacity = arguments.length > 1 && arguments[1] !== void 0 ? arguments[1] : null;\n\n      var _this = this;\n\n      var _this_props_history;\n\n      if (forceOpacity === null && ((_this_props_history = this.props.history) === null || _this_props_history === void 0 ? void 0 : _this_props_history[0]) !== modalState.id) {\n        return;\n      }\n\n      if (this.maskAnimationFrame) {\n        cancelAnimationFrame(this.maskAnimationFrame);\n      }\n\n      this.maskAnimationFrame = requestAnimationFrame(function () {\n        if (_this.maskElementRef.current) {\n          var _modalState_translateY = modalState.translateY,\n              translateY = _modalState_translateY === void 0 ? 0 : _modalState_translateY,\n              _modalState_translateYCurrent = modalState.translateYCurrent,\n              translateYCurrent = _modalState_translateYCurrent === void 0 ? 0 : _modalState_translateYCurrent;\n          var opacity = forceOpacity === null ? 1 - (translateYCurrent - translateY) / (100 - translateY) || 0 : forceOpacity;\n          _this.maskElementRef.current.style.opacity = clamp(opacity, 0, 100).toString();\n          _this.maskElementRef.current.style.transitionDelay = opacity && _this.props.delayEnter ? \"\".concat(_this.timeout, \"ms\") : \"\";\n        }\n      });\n    }\n  }, {\n    key: \"render\",\n    value: function render() {\n      var _this = this;\n\n      var _this_props_configProvider;\n\n      var _this_props = this.props,\n          activeModal = _this_props.activeModal,\n          exitingModal = _this_props.exitingModal,\n          enteringModal = _this_props.enteringModal;\n      var _this_state = this.state,\n          touchDown = _this_state.touchDown,\n          dragging = _this_state.dragging;\n\n      if (!activeModal && !exitingModal) {\n        return null;\n      }\n\n      return /*#__PURE__*/React.createElement(TouchRootContext.Provider, {\n        value: true\n      }, /*#__PURE__*/React.createElement(ModalRootContext.Provider, {\n        value: this.modalRootContext\n      }, /*#__PURE__*/React.createElement(Touch, {\n        className: classNames(\"vkuiModalRoot\", ((_this_props_configProvider = this.props.configProvider) === null || _this_props_configProvider === void 0 ? void 0 : _this_props_configProvider.hasCustomPanelHeaderAfter) && \"vkuiModalRoot--hasCustomPanelHeaderAfterSlot\", touchDown && classNames(\"vkuiModalRoot--touched\", \"vkuiInternalModalRoot--touched\"), !!(enteringModal || exitingModal) && classNames(\"vkuiModalRoot--switching\", \"vkuiInternalModalRoot--switching\")),\n        onMove: this.onTouchMove,\n        onEnd: this.onTouchEnd,\n        onScroll: this.onScroll\n      }, /*#__PURE__*/React.createElement(\"div\", {\n        className: \"vkuiModalRoot__mask\",\n        onClick: this.props.onExit,\n        ref: this.maskElementRef\n      }), /*#__PURE__*/React.createElement(\"div\", {\n        className: \"vkuiModalRoot__viewport\",\n        ref: this.viewportRef\n      }, this.getModals().map(function (Modal) {\n        var modalId = getNavId(Modal.props, warn);\n\n        var _modalState = _this.props.getModalState(modalId);\n\n        if (modalId !== activeModal && modalId !== exitingModal || !_modalState) {\n          return null;\n        }\n\n        var modalState = _object_spread({}, _modalState);\n\n        var isPage = modalState.type === ModalType.PAGE;\n        var key = \"modal-\".concat(modalId);\n        return /*#__PURE__*/React.createElement(FocusTrap, {\n          key: key,\n          onClose: _this.props.onExit,\n          timeout: _this.timeout,\n          className: classNames(\"vkuiModalRoot__modal\", dragging && \"vkuiInternalModalRoot__modal--dragging\", isPage && modalState.expandable && \"vkuiInternalModalRoot__modal--expandable\", isPage && modalState.collapsed && \"vkuiInternalModalRoot__modal--collapsed\"),\n          restoreFocus: false\n        }, Modal);\n      })))));\n    }\n  }]);\n\n  return ModalRootTouchComponent;\n}(React.Component);\n\nexport var ModalRootTouch = withContext(withPlatform(withDOM(withModalManager(initModal)(ModalRootTouchComponent))), ConfigProviderContext, \"configProvider\");\n/**\n * Инициализирует модалку перед анимацией открытия\n */\n\nfunction initModal(modalState) {\n  switch (modalState.type) {\n    case ModalType.PAGE:\n      modalState.settlingHeight = modalState.settlingHeight || MODAL_PAGE_DEFAULT_PERCENT_HEIGHT;\n      return initPageModal(modalState);\n\n    case ModalType.CARD:\n      return initCardModal(modalState);\n\n    default:\n      process.env.NODE_ENV === \"development\" && warn('initActiveModal: modalState.type=\"'.concat(modalState.type, '\" не поддерживается'), \"error\");\n  }\n}\n\nfunction initPageModal(modalState) {\n  var contentElement = modalState.contentElement,\n      bottomInset = modalState.bottomInset;\n  var contentElementHeight = (contentElement === null || contentElement === void 0 ? void 0 : contentElement.firstElementChild).scrollHeight;\n  var bottomInsetHeight = (bottomInset === null || bottomInset === void 0 ? void 0 : bottomInset.offsetHeight) || 0;\n  var contentHeight = contentElementHeight + bottomInsetHeight;\n  var prevTranslateY = modalState.translateY;\n\n  var _contentElement_clientHeight;\n\n  modalState.expandable = contentHeight > ((_contentElement_clientHeight = contentElement === null || contentElement === void 0 ? void 0 : contentElement.clientHeight) !== null && _contentElement_clientHeight !== void 0 ? _contentElement_clientHeight : 0) || modalState.settlingHeight === 100 || modalState.expanded;\n  var collapsed = false;\n  var expanded = false;\n  var translateYFrom;\n  var translateY;\n  var expandedRange;\n  var collapsedRange;\n  var hiddenRange;\n  var hasCollapsedState = Boolean(modalState.expandable && modalState.settlingHeight !== 100);\n\n  if (modalState.expandable) {\n    var _modalState_settlingHeight;\n\n    translateYFrom = 100 - ((_modalState_settlingHeight = modalState.settlingHeight) !== null && _modalState_settlingHeight !== void 0 ? _modalState_settlingHeight : 0);\n    var shiftHalf = translateYFrom / 2;\n    var visiblePart = 100 - translateYFrom;\n    expandedRange = [0, shiftHalf];\n    collapsedRange = hasCollapsedState ? [shiftHalf, translateYFrom + visiblePart / 4] : undefined;\n    hiddenRange = [translateYFrom + visiblePart / 4, 100];\n    collapsed = hasCollapsedState && translateYFrom > 0;\n    expanded = translateYFrom <= 0;\n    translateY = translateYFrom;\n  } else {\n    var _modalState_headerElement, _modalState_innerElement_parentElement, _modalState_innerElement;\n\n    var _modalState_headerElement_offsetHeight;\n\n    var headerHeight = (_modalState_headerElement_offsetHeight = (_modalState_headerElement = modalState.headerElement) === null || _modalState_headerElement === void 0 ? void 0 : _modalState_headerElement.offsetHeight) !== null && _modalState_headerElement_offsetHeight !== void 0 ? _modalState_headerElement_offsetHeight : 0;\n    var height = contentHeight + headerHeight;\n\n    var _modalState_innerElement_parentElement_offsetHeight;\n\n    translateYFrom = 100 - height / ((_modalState_innerElement_parentElement_offsetHeight = (_modalState_innerElement = modalState.innerElement) === null || _modalState_innerElement === void 0 ? void 0 : (_modalState_innerElement_parentElement = _modalState_innerElement.parentElement) === null || _modalState_innerElement_parentElement === void 0 ? void 0 : _modalState_innerElement_parentElement.offsetHeight) !== null && _modalState_innerElement_parentElement_offsetHeight !== void 0 ? _modalState_innerElement_parentElement_offsetHeight : 0) * 100;\n    translateY = translateYFrom;\n    expandedRange = [translateY, translateY + 25];\n    collapsedRange = undefined;\n    hiddenRange = [translateY + 25, translateY + 100];\n  } // Если модалка может открываться на весь экран, и новый сдвиг больше предыдущего, то откроем её на весь экран\n\n\n  if (modalState.expandable && translateY > (prevTranslateY !== null && prevTranslateY !== void 0 ? prevTranslateY : 100) || modalState.settlingHeight === 100) {\n    translateY = 0;\n  } // Если модалка уже раскрыта обновляем состояния\n\n\n  if (translateY === 0) {\n    expanded = true;\n    collapsed = false;\n  }\n\n  modalState.expandedRange = expandedRange;\n  modalState.collapsedRange = collapsedRange;\n  modalState.hiddenRange = hiddenRange;\n  modalState.translateY = translateY;\n  modalState.translateYFrom = translateYFrom;\n  modalState.collapsed = collapsed;\n  modalState.expanded = expanded;\n}\n\nfunction initCardModal(modalState) {\n  modalState.translateY = 0;\n}","map":{"version":3,"mappings":"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","names":["React","classNames","clamp","withContext","withPlatform","withDOM","getNavId","Platform","setTransformStyle","transitionEvent","rubber","warnOnce","ConfigProviderContext","FocusTrap","Touch","TouchRootContext","ModalRootContext","MODAL_PAGE_DEFAULT_PERCENT_HEIGHT","ModalType","withModalManager","warn","numberInRange","number","range","rangeTranslate","ModalRootTouchComponent","_React_Component","props","_define_property","documentScrolling","maskElementRef","viewportRef","createRef","maskAnimationFrame","undefined","modalRootContext","frameIds","restoreFocusTo","preventTouch","event","originalEvent","preventDefault","updateModalHeight","modalState","_this","getModalState","activeModal","type","PAGE","enteringModal","waitTransitionFinish","requestAnimationFrame","checkPageContentHeight","onTouchMove","e","exitingModal","onPageTouchMove","CARD","onCardTouchMove","onTouchEnd","onPageTouchEnd","onCardTouchEnd","onScroll","target","contentElement","contains","contentScrolled","contentScrollStopTimeout","clearTimeout","setTimeout","state","touchDown","dragging","modalOpenedLog","registerModal","id","data","_this_props_getModalState","Object","assign","onClose","onExit","isInsideModal","timeout","platform","IOS","document","window","getModals","Children","toArray","children","componentDidMount","_this_window","addEventListener","componentWillUnmount","toggleDocumentScrolling","removeEventListener","componentDidUpdate","prevProps","closeModal","enteringState","onEnter","innerElement","style","transitionDelay","onEntered","delayEnter","concat","animateTranslate","translateY","setMaskOpacity","activeElement","focus","enabled","documentElement","classList","remove","passive","add","modalElement","prevModalState","_object_spread","initPageModal","currentModalState","needAnimate","expandable","translateYFrom","param","noFocusToDialog","setState","length","prevState","_to_consumable_array","nextModalState","nextIsPage","prevIsPage","onExited","exitTranslate","isBack","includes","shiftY","isY","_this_viewportRef_current","current","stopPropagation","collapsed","expanded","touchStartContentScrollTop","scrollTop","touchMovePositive","headerElement","shiftYPercent","innerHeight","shiftYCurrent","touchShiftYPercent","translateYCurrent","offsetHeight","Math","max","startY","setStateCallback","shiftYEndPercent","expectTranslateY","duration","settlingHeight","expandedRange","collapsedRange","hiddenRange","hidden","eventHandler","supported","onceHandler","name","percent","frameId","cancelAnimationFrame","forceOpacity","_this_props_history","history","_modalState_translateY","_modalState_translateYCurrent","opacity","toString","render","_this_props_configProvider","_this_props","_this_state","Provider","value","className","configProvider","hasCustomPanelHeaderAfter","onMove","onEnd","div","onClick","ref","map","Modal","modalId","_modalState","isPage","key","restoreFocus","Component","ModalRootTouch","initModal","initCardModal","process","env","NODE_ENV","bottomInset","contentElementHeight","firstElementChild","scrollHeight","bottomInsetHeight","contentHeight","prevTranslateY","clientHeight","hasCollapsedState","Boolean","shiftHalf","visiblePart","headerHeight","height","parentElement"],"sources":["C:\\Users\\kulag\\vk\\Ability\\node_modules\\@vkontakte\\vkui\\src\\components\\ModalRoot\\ModalRoot.tsx"],"sourcesContent":["import * as React from 'react';\nimport { classNames } from '@vkontakte/vkjs';\nimport { clamp } from '../../helpers/math';\nimport { withContext } from '../../hoc/withContext';\nimport { withPlatform } from '../../hoc/withPlatform';\nimport { DOMProps, withDOM } from '../../lib/dom';\nimport { getNavId } from '../../lib/getNavId';\nimport { Platform } from '../../lib/platform';\nimport { setTransformStyle } from '../../lib/styles';\nimport { transitionEvent } from '../../lib/supportEvents';\nimport { rubber } from '../../lib/touch';\nimport { warnOnce } from '../../lib/warnOnce';\nimport { ConfigProviderContext } from '../ConfigProvider/ConfigProviderContext';\nimport { FocusTrap } from '../FocusTrap/FocusTrap';\nimport { Touch, TouchEvent } from '../Touch/Touch';\nimport TouchRootContext from '../Touch/TouchContext';\nimport { ModalRootContext, ModalRootContextInterface } from './ModalRootContext';\nimport { MODAL_PAGE_DEFAULT_PERCENT_HEIGHT } from './constants';\nimport { ModalRootWithDOMProps, ModalsStateEntry, ModalType, TranslateRange } from './types';\nimport { ModalTransitionProps, withModalManager } from './useModalManager';\nimport styles from './ModalRoot.module.css';\n\nconst warn = warnOnce('ModalRoot');\n\nfunction numberInRange(number: number, range: TranslateRange | undefined) {\n  if (!range) {\n    return false;\n  }\n  return number >= range[0] && number <= range[1];\n}\n\nfunction rangeTranslate(number: number) {\n  return clamp(number, 0, 98);\n}\n\ninterface ModalRootState {\n  touchDown?: boolean;\n  dragging?: boolean;\n  modalOpenedLog: string[];\n}\n\nclass ModalRootTouchComponent extends React.Component<\n  ModalRootWithDOMProps & DOMProps & ModalTransitionProps,\n  ModalRootState\n> {\n  constructor(props: ModalRootWithDOMProps & ModalTransitionProps) {\n    super(props);\n    this.state = {\n      touchDown: false,\n      dragging: false,\n      modalOpenedLog: [],\n    };\n\n    this.maskElementRef = React.createRef();\n\n    this.modalRootContext = {\n      updateModalHeight: this.updateModalHeight,\n      registerModal: ({ id, ...data }) => Object.assign(this.props.getModalState(id) ?? {}, data),\n      onClose: () => this.props.onExit(),\n      isInsideModal: true,\n    };\n\n    this.frameIds = {};\n  }\n\n  private documentScrolling = false;\n  private readonly maskElementRef: React.RefObject<HTMLDivElement>;\n  private readonly viewportRef = React.createRef<HTMLDivElement>();\n  private maskAnimationFrame: number | undefined = undefined;\n  private readonly modalRootContext: ModalRootContextInterface;\n  private readonly frameIds: {\n    [index: string]: number;\n  };\n  private restoreFocusTo: HTMLElement | undefined | null = undefined;\n\n  get timeout(): number {\n    return this.props.platform === Platform.IOS ? 400 : 320;\n  }\n\n  get document(): Document {\n    return this.props.document as Document;\n  }\n\n  get window(): Window {\n    return this.props.window as Window;\n  }\n\n  getModals() {\n    return React.Children.toArray(this.props.children) as React.ReactElement[];\n  }\n\n  componentDidMount() {\n    // Отслеживаем изменение размеров viewport\n    this.window?.addEventListener('resize', this.updateModalHeight, false);\n  }\n\n  componentWillUnmount() {\n    this.toggleDocumentScrolling(true);\n    this.window.removeEventListener('resize', this.updateModalHeight, false);\n  }\n\n  componentDidUpdate(prevProps: ModalRootWithDOMProps & ModalTransitionProps) {\n    // transition phase 2: animate exiting modal\n    if (this.props.exitingModal && this.props.exitingModal !== prevProps.exitingModal) {\n      this.closeModal(this.props.exitingModal);\n    }\n\n    // transition phase 3: animate entering modal\n    if (this.props.enteringModal && this.props.enteringModal !== prevProps.enteringModal) {\n      const enteringState = this.props.getModalState(this.props.enteringModal);\n      this.props.onEnter();\n      this.waitTransitionFinish(enteringState, () => {\n        if (enteringState) {\n          if (enteringState.innerElement) {\n            enteringState.innerElement.style.transitionDelay = '';\n          }\n          this.onEntered(enteringState);\n        }\n      });\n\n      if (enteringState?.innerElement) {\n        enteringState.innerElement.style.transitionDelay = this.props.delayEnter\n          ? `${this.timeout}ms`\n          : '';\n        this.animateTranslate(enteringState, enteringState.translateY);\n        this.setMaskOpacity(enteringState, 1);\n      }\n    }\n\n    // focus restoration\n    if (this.props.activeModal && !prevProps.activeModal) {\n      this.restoreFocusTo = this.document.activeElement as HTMLElement;\n    }\n    if (!this.props.activeModal && !this.props.exitingModal && this.restoreFocusTo) {\n      this.restoreFocusTo.focus();\n      this.restoreFocusTo = null;\n    }\n\n    this.toggleDocumentScrolling(!this.props.activeModal && !this.props.exitingModal);\n  }\n\n  /* Отключает скролл документа */\n  toggleDocumentScrolling(enabled: boolean) {\n    if (this.documentScrolling === enabled) {\n      return;\n    }\n    this.documentScrolling = enabled;\n\n    if (enabled) {\n      // восстанавливаем значение overscroll behavior\n      // eslint-disable-next-line no-restricted-properties\n      this.document.documentElement.classList.remove('vkui--disable-overscroll-behavior');\n\n      // некоторые браузеры на странных вендорах типа Meizu не удаляют обработчик.\n      // https://github.com/VKCOM/VKUI/issues/444\n      this.window.removeEventListener('touchmove', this.preventTouch, {\n        // @ts-expect-error: TS2769 В интерфейсе EventListenerOptions нет поля passive\n        passive: false,\n      });\n    } else {\n      // отключаем нативный pull-to-refresh при открытом модальном окне\n      // чтобы он не срабатывал при закрытии модалки смахиванием вниз\n      // eslint-disable-next-line no-restricted-properties\n      this.document.documentElement.classList.add('vkui--disable-overscroll-behavior');\n\n      this.window.addEventListener('touchmove', this.preventTouch, {\n        passive: false,\n      });\n    }\n  }\n\n  preventTouch = (event: any) => {\n    if (!event) {\n      return false;\n    }\n    while (event.originalEvent) {\n      event = event.originalEvent;\n    }\n    if (event.preventDefault) {\n      event.preventDefault();\n    }\n    return false;\n  };\n\n  checkPageContentHeight() {\n    const modalState = this.props.getModalState(this.props.activeModal);\n\n    if (modalState?.type === ModalType.PAGE && modalState?.modalElement) {\n      const prevModalState = { ...modalState };\n      initPageModal(modalState);\n      const currentModalState = { ...modalState };\n\n      let needAnimate = false;\n\n      if (prevModalState.expandable === currentModalState.expandable) {\n        if (prevModalState.translateYFrom !== currentModalState.translateYFrom) {\n          needAnimate = true;\n        }\n      } else {\n        needAnimate = true;\n      }\n\n      if (needAnimate) {\n        this.animateTranslate(modalState, modalState.translateY);\n      }\n    }\n  }\n\n  updateModalHeight = () => {\n    const modalState = this.props.getModalState(this.props.activeModal);\n\n    if (modalState && modalState.type === ModalType.PAGE) {\n      if (this.props.enteringModal) {\n        this.waitTransitionFinish(modalState, () => {\n          requestAnimationFrame(() => this.checkPageContentHeight());\n        });\n      } else {\n        requestAnimationFrame(() => this.checkPageContentHeight());\n      }\n    }\n  };\n\n  onEntered({ id, modalElement }: ModalsStateEntry) {\n    if (\n      !this.props.noFocusToDialog &&\n      modalElement &&\n      !modalElement.contains(this.document.activeElement)\n    ) {\n      modalElement.focus();\n    }\n\n    this.props.onEntered(id);\n  }\n\n  closeModal(id: string) {\n    // Сбрасываем состояния, которые могут помешать закрытию модального окна\n    this.setState({ touchDown: false });\n\n    const prevModalState = this.props.getModalState(id);\n\n    if (!prevModalState) {\n      id && warn(`closeActiveModal: модальное окно (страница) ${id} не существует`, 'error');\n      return;\n    }\n    if (!this.state.modalOpenedLog.length) {\n      this.setState((prevState) => ({\n        modalOpenedLog: [...prevState.modalOpenedLog, id],\n      }));\n    }\n    const nextModalState = this.props.getModalState(this.props.activeModal);\n    const nextIsPage = !!nextModalState && nextModalState.type === ModalType.PAGE;\n\n    const prevIsPage = !!prevModalState && prevModalState.type === ModalType.PAGE;\n    this.waitTransitionFinish(prevModalState, () => this.props.onExited(id));\n    const exitTranslate =\n      prevIsPage &&\n      nextIsPage &&\n      (prevModalState.translateY ?? 0) <= (nextModalState?.translateYFrom ?? 0) &&\n      !this.props.isBack\n        ? (nextModalState?.translateYFrom ?? 0) + 10\n        : 100;\n    this.animateTranslate(prevModalState, exitTranslate);\n\n    if (!nextModalState) {\n      // NOTE: was only for clean exit\n      this.setMaskOpacity(prevModalState, 0);\n      this.setState({ modalOpenedLog: [] });\n      prevModalState.translateY = undefined;\n    } else if (nextModalState.id && !this.state.modalOpenedLog.includes(nextModalState.id)) {\n      nextModalState.translateY = undefined;\n      this.setState((prevState) => ({\n        modalOpenedLog: [...prevState.modalOpenedLog, nextModalState.id!],\n      }));\n    }\n  }\n\n  onTouchMove = (e: TouchEvent) => {\n    if (this.props.exitingModal) {\n      return;\n    }\n    const modalState = this.props.getModalState(this.props.activeModal);\n    if (!modalState) {\n      return;\n    }\n\n    if (modalState.type === ModalType.PAGE) {\n      return this.onPageTouchMove(e, modalState);\n    }\n\n    if (modalState.type === ModalType.CARD) {\n      return this.onCardTouchMove(e, modalState);\n    }\n  };\n\n  onPageTouchMove(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { shiftY, originalEvent } = event;\n    const target = originalEvent.target as HTMLElement;\n\n    if (!event.isY) {\n      if (this.viewportRef.current?.contains(target)) {\n        originalEvent.preventDefault();\n      }\n      return;\n    }\n\n    if (!modalState.innerElement?.contains(target)) {\n      return originalEvent.preventDefault();\n    }\n\n    originalEvent.stopPropagation();\n\n    const { expandable, contentScrolled, collapsed, expanded } = modalState;\n\n    if (!this.state.touchDown) {\n      modalState.touchStartContentScrollTop = modalState.contentElement?.scrollTop ?? 0;\n      this.setState({ touchDown: true });\n    }\n\n    if (contentScrolled) {\n      return;\n    }\n\n    if (modalState.touchMovePositive === null) {\n      modalState.touchMovePositive = shiftY > 0;\n    }\n\n    if (\n      !modalState.expandable ||\n      collapsed ||\n      (expanded && modalState.touchMovePositive && modalState.touchStartContentScrollTop === 0) ||\n      modalState.headerElement?.contains(target)\n    ) {\n      originalEvent.preventDefault();\n\n      if ((!expandable && shiftY < 0) || !this.window) {\n        return;\n      }\n\n      !this.state.dragging && this.setState({ dragging: true });\n\n      const shiftYPercent = (shiftY / this.window.innerHeight) * 100;\n      const shiftYCurrent = rubber(shiftYPercent, 72, 0.8, this.props.platform !== Platform.IOS);\n\n      modalState.touchShiftYPercent = shiftYPercent;\n      modalState.translateYCurrent = rangeTranslate((modalState.translateY ?? 0) + shiftYCurrent);\n\n      this.animateTranslate(modalState, modalState.translateYCurrent);\n      this.setMaskOpacity(modalState);\n    }\n  }\n\n  onCardTouchMove(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { originalEvent, shiftY } = event;\n    const target = originalEvent.target as HTMLElement;\n    if (modalState.innerElement?.contains(target)) {\n      if (!this.state.touchDown) {\n        this.setState({ touchDown: true, dragging: true });\n      }\n\n      const shiftYPercent = (shiftY / modalState.innerElement.offsetHeight) * 100;\n      const shiftYCurrent = rubber(shiftYPercent, 72, 1.2, this.props.platform !== Platform.IOS);\n\n      modalState.touchShiftYPercent = shiftYPercent;\n      modalState.translateYCurrent = Math.max(0, (modalState.translateY ?? 0) + shiftYCurrent);\n\n      this.animateTranslate(modalState, modalState.translateYCurrent);\n      this.setMaskOpacity(modalState);\n    }\n  }\n\n  onTouchEnd = (e: TouchEvent) => {\n    const modalState = this.props.getModalState(this.props.activeModal);\n\n    if (modalState?.type === ModalType.PAGE) {\n      return this.onPageTouchEnd(e, modalState);\n    }\n\n    if (modalState?.type === ModalType.CARD) {\n      return this.onCardTouchEnd(e, modalState);\n    }\n  };\n\n  onPageTouchEnd(event: TouchEvent, modalState: ModalsStateEntry) {\n    const { startY, shiftY } = event;\n\n    modalState.contentScrolled = false;\n    modalState.touchMovePositive = null;\n\n    let setStateCallback;\n\n    if (this.state.dragging && this.window) {\n      const shiftYEndPercent = ((startY + shiftY) / this.window.innerHeight) * 100;\n\n      let translateY = modalState.translateYCurrent ?? 0;\n      const expectTranslateY =\n        (translateY / event.duration) *\n        240 *\n        0.6 *\n        ((modalState.touchShiftYPercent ?? 0) < 0 ? -1 : 1);\n      translateY = rangeTranslate(translateY + expectTranslateY);\n\n      if (modalState.settlingHeight !== 100) {\n        if (numberInRange(translateY, modalState.expandedRange)) {\n          translateY = modalState.expandedRange?.[0] ?? 0;\n        } else if (numberInRange(translateY, modalState.collapsedRange)) {\n          translateY = modalState.translateYFrom ?? 0;\n        } else if (numberInRange(translateY, modalState.hiddenRange)) {\n          translateY = 100;\n        } else {\n          translateY = modalState.translateYFrom ?? 0;\n        }\n      } else {\n        if (numberInRange(translateY, [0, 25])) {\n          translateY = 0;\n        } else {\n          translateY = 100;\n        }\n      }\n\n      if (translateY !== 100 && shiftYEndPercent >= 75) {\n        translateY = 100;\n      }\n\n      modalState.translateY = translateY;\n      modalState.translateYCurrent = translateY;\n      modalState.collapsed = numberInRange(translateY, modalState.collapsedRange);\n      modalState.expanded = translateY === 0;\n      modalState.hidden = translateY === 100;\n\n      if (modalState.hidden) {\n        this.props.onExit();\n      }\n\n      setStateCallback = () => {\n        if (!modalState.hidden) {\n          this.animateTranslate(modalState, modalState.translateY);\n        }\n\n        this.setMaskOpacity(modalState);\n      };\n    }\n\n    this.setState(\n      {\n        touchDown: false,\n        dragging: false,\n      },\n      setStateCallback,\n    );\n  }\n\n  onCardTouchEnd({ duration }: TouchEvent, modalState: ModalsStateEntry) {\n    let setStateCallback;\n\n    if (this.state.dragging) {\n      let translateY = modalState.translateYCurrent ?? 0;\n\n      const expectTranslateY =\n        (translateY / duration) * 240 * 0.6 * ((modalState.touchShiftYPercent ?? 0) < 0 ? -1 : 1);\n      translateY = Math.max(0, translateY + expectTranslateY);\n\n      if (translateY >= 30) {\n        translateY = 100;\n      } else {\n        translateY = 0;\n      }\n\n      modalState.translateY = translateY;\n      modalState.hidden = translateY === 100;\n\n      if (modalState.hidden) {\n        this.props.onExit();\n      }\n\n      setStateCallback = () => {\n        if (!modalState.hidden) {\n          this.animateTranslate(modalState, modalState.translateY);\n        }\n\n        this.setMaskOpacity(modalState);\n      };\n    }\n\n    this.setState(\n      {\n        touchDown: false,\n        dragging: false,\n      },\n      setStateCallback,\n    );\n  }\n\n  onScroll = (e: React.SyntheticEvent) => {\n    const activeModal = this.props.activeModal;\n\n    const target = e.target as HTMLElement;\n\n    if (!activeModal) {\n      return;\n    }\n    const modalState = this.props.getModalState(activeModal);\n    if (modalState?.type === ModalType.PAGE && modalState?.contentElement?.contains(target)) {\n      modalState.contentScrolled = true;\n\n      if (modalState.contentScrollStopTimeout) {\n        clearTimeout(modalState.contentScrollStopTimeout);\n      }\n\n      modalState.contentScrollStopTimeout = setTimeout(() => {\n        if (modalState.contentScrolled) {\n          modalState.contentScrolled = false;\n        }\n      }, 250);\n    }\n  };\n\n  waitTransitionFinish(modalState: ModalsStateEntry | undefined, eventHandler: () => void) {\n    if (transitionEvent.supported) {\n      const onceHandler = () => {\n        modalState?.innerElement?.removeEventListener(transitionEvent.name as string, onceHandler);\n        eventHandler();\n      };\n\n      modalState?.innerElement?.addEventListener(transitionEvent.name as string, onceHandler);\n    } else {\n      setTimeout(eventHandler, this.timeout);\n    }\n  }\n\n  /**\n   * Анимирует сдвиг модалки\n   *\n   * @param {ModalsStateEntry} modalState\n   * @param {number} percent Процент сдвига: 0 – полностью открыта, 100 – полностью закрыта\n   */\n  animateTranslate(modalState: ModalsStateEntry, percent: number | undefined) {\n    const frameId = `animateTranslateFrame${modalState.id}`;\n\n    cancelAnimationFrame(this.frameIds[frameId]);\n\n    this.frameIds[frameId] = requestAnimationFrame(() => {\n      setTransformStyle(modalState.innerElement, `translate3d(0, ${percent}%, 0)`);\n    });\n  }\n\n  /* Устанавливает прозрачность для полупрозрачной подложки */\n  setMaskOpacity(modalState: ModalsStateEntry, forceOpacity: number | null = null) {\n    if (forceOpacity === null && this.props.history?.[0] !== modalState.id) {\n      return;\n    }\n    if (this.maskAnimationFrame) {\n      cancelAnimationFrame(this.maskAnimationFrame);\n    }\n    this.maskAnimationFrame = requestAnimationFrame(() => {\n      if (this.maskElementRef.current) {\n        const { translateY = 0, translateYCurrent = 0 } = modalState;\n\n        const opacity =\n          forceOpacity === null\n            ? 1 - (translateYCurrent - translateY) / (100 - translateY) || 0\n            : forceOpacity;\n        this.maskElementRef.current.style.opacity = clamp(opacity, 0, 100).toString();\n        this.maskElementRef.current.style.transitionDelay =\n          opacity && this.props.delayEnter ? `${this.timeout}ms` : '';\n      }\n    });\n  }\n\n  render() {\n    const { activeModal, exitingModal, enteringModal } = this.props;\n    const { touchDown, dragging } = this.state;\n\n    if (!activeModal && !exitingModal) {\n      return null;\n    }\n\n    return (\n      <TouchRootContext.Provider value={true}>\n        <ModalRootContext.Provider value={this.modalRootContext}>\n          <Touch\n            className={classNames(\n              styles['ModalRoot'],\n              this.props.configProvider?.hasCustomPanelHeaderAfter &&\n                styles['ModalRoot--hasCustomPanelHeaderAfterSlot'],\n              touchDown &&\n                classNames(styles['ModalRoot--touched'], 'vkuiInternalModalRoot--touched'),\n              !!(enteringModal || exitingModal) &&\n                classNames(styles['ModalRoot--switching'], 'vkuiInternalModalRoot--switching'),\n            )}\n            onMove={this.onTouchMove}\n            onEnd={this.onTouchEnd}\n            onScroll={this.onScroll}\n          >\n            <div\n              className={styles['ModalRoot__mask']}\n              onClick={this.props.onExit}\n              ref={this.maskElementRef}\n            />\n            <div className={styles['ModalRoot__viewport']} ref={this.viewportRef}>\n              {this.getModals().map((Modal) => {\n                const modalId = getNavId(Modal.props, warn);\n                const _modalState = this.props.getModalState(modalId);\n                if ((modalId !== activeModal && modalId !== exitingModal) || !_modalState) {\n                  return null;\n                }\n                const modalState = { ..._modalState };\n\n                const isPage = modalState.type === ModalType.PAGE;\n                const key = `modal-${modalId}`;\n\n                return (\n                  <FocusTrap\n                    key={key}\n                    onClose={this.props.onExit}\n                    timeout={this.timeout}\n                    className={classNames(\n                      styles['ModalRoot__modal'],\n\n                      dragging && 'vkuiInternalModalRoot__modal--dragging',\n\n                      isPage && modalState.expandable && 'vkuiInternalModalRoot__modal--expandable',\n                      isPage && modalState.collapsed && 'vkuiInternalModalRoot__modal--collapsed',\n                    )}\n                    restoreFocus={false}\n                  >\n                    {Modal}\n                  </FocusTrap>\n                );\n              })}\n            </div>\n          </Touch>\n        </ModalRootContext.Provider>\n      </TouchRootContext.Provider>\n    );\n  }\n}\n\nexport const ModalRootTouch = withContext(\n  withPlatform(\n    withDOM<ModalRootWithDOMProps>(withModalManager(initModal)(ModalRootTouchComponent)),\n  ),\n  ConfigProviderContext,\n  'configProvider',\n);\n\n/**\n * Инициализирует модалку перед анимацией открытия\n */\nfunction initModal(modalState: ModalsStateEntry) {\n  switch (modalState.type) {\n    case ModalType.PAGE:\n      modalState.settlingHeight = modalState.settlingHeight || MODAL_PAGE_DEFAULT_PERCENT_HEIGHT;\n      return initPageModal(modalState);\n    case ModalType.CARD:\n      return initCardModal(modalState);\n    default:\n      process.env.NODE_ENV === 'development' &&\n        warn(`initActiveModal: modalState.type=\"${modalState.type}\" не поддерживается`, 'error');\n  }\n}\n\nfunction initPageModal(modalState: ModalsStateEntry) {\n  const { contentElement, bottomInset } = modalState;\n  const contentElementHeight = (contentElement?.firstElementChild as HTMLElement).scrollHeight;\n  const bottomInsetHeight = bottomInset?.offsetHeight || 0;\n  const contentHeight = contentElementHeight + bottomInsetHeight;\n  let prevTranslateY = modalState.translateY;\n\n  modalState.expandable =\n    contentHeight > (contentElement?.clientHeight ?? 0) ||\n    modalState.settlingHeight === 100 ||\n    modalState.expanded;\n\n  let collapsed = false;\n  let expanded = false;\n  let translateYFrom;\n  let translateY;\n  let expandedRange: TranslateRange;\n  let collapsedRange: TranslateRange | undefined;\n  let hiddenRange: TranslateRange;\n\n  const hasCollapsedState = Boolean(modalState.expandable && modalState.settlingHeight !== 100);\n  if (modalState.expandable) {\n    translateYFrom = 100 - (modalState.settlingHeight ?? 0);\n\n    const shiftHalf = translateYFrom / 2;\n    const visiblePart = 100 - translateYFrom;\n\n    expandedRange = [0, shiftHalf];\n    collapsedRange = hasCollapsedState ? [shiftHalf, translateYFrom + visiblePart / 4] : undefined;\n    hiddenRange = [translateYFrom + visiblePart / 4, 100];\n\n    collapsed = hasCollapsedState && translateYFrom > 0;\n    expanded = translateYFrom <= 0;\n    translateY = translateYFrom;\n  } else {\n    const headerHeight = modalState.headerElement?.offsetHeight ?? 0;\n    const height = contentHeight + headerHeight;\n\n    translateYFrom =\n      100 - (height / (modalState.innerElement?.parentElement?.offsetHeight ?? 0)) * 100;\n    translateY = translateYFrom;\n\n    expandedRange = [translateY, translateY + 25];\n    collapsedRange = undefined;\n    hiddenRange = [translateY + 25, translateY + 100];\n  }\n\n  // Если модалка может открываться на весь экран, и новый сдвиг больше предыдущего, то откроем её на весь экран\n  if (\n    (modalState.expandable && translateY > (prevTranslateY ?? 100)) ||\n    modalState.settlingHeight === 100\n  ) {\n    translateY = 0;\n  }\n\n  // Если модалка уже раскрыта обновляем состояния\n  if (translateY === 0) {\n    expanded = true;\n    collapsed = false;\n  }\n\n  modalState.expandedRange = expandedRange;\n  modalState.collapsedRange = collapsedRange;\n  modalState.hiddenRange = hiddenRange;\n  modalState.translateY = translateY;\n  modalState.translateYFrom = translateYFrom;\n  modalState.collapsed = collapsed;\n  modalState.expanded = expanded;\n}\n\nfunction initCardModal(modalState: ModalsStateEntry) {\n  modalState.translateY = 0;\n}\n"]},"metadata":{},"sourceType":"module"}